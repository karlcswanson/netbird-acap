
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

stages:
  - prepare
  - build
  - release

get-version:
  stage: prepare
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq git
  script:
    - TAG=$(curl -fsSL https://api.github.com/repos/netbirdio/netbird/releases/latest | jq -r .tag_name)
    - VERSION=${TAG#v}
    - echo "VERSION=$VERSION" >> build.env
    - echo "BUILD_NEEDED=true" >> build.env
    - echo "NetBird version=$VERSION"
  artifacts:
    reports:
      dotenv: build.env

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  needs:
    - get-version
  before_script:
    - apk add --no-cache bash curl
    - echo "Building version $VERSION"
  script:
    - chmod +x build.sh
    - export NETBIRD_VERSION=$VERSION
    - ./build.sh
    - |
      if [ $(find dist -name "*.eap" | wc -l) -eq 0 ]; then
        echo "Error: No .eap files generated"
        exit 1
      fi
    - echo "Built artifacts:"
    - find dist -name "*.eap" -exec ls -lh {} \;
  artifacts:
    paths:
      - dist/

release:
  stage: release
  image: alpine:latest
  needs:
    - get-version
    - build
  before_script:
    - apk add --no-cache curl jq
    - echo "Creating release for version $VERSION"
  script:
    - |
      for eap_file in dist/*/*.eap; do
        [ -f "$eap_file" ] || continue
        filename=$(basename "$eap_file")
        echo "Uploading $filename..."
        curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
             --upload-file "$eap_file" \
             "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/netbird-acap/${VERSION}/${filename}"
      done
    - |
      cat > description.txt << 'EOF'
      NetBird ACAP for Axis cameras

      Architectures: armv7hf, aarch64

      Upstream: https://github.com/netbirdio/netbird/releases/tag/vVERSION_PLACEHOLDER
      EOF
      DESCRIPTION=$(sed "s/VERSION_PLACEHOLDER/${VERSION}/g" description.txt)
    - |
      ASSETS='[]'
      for eap_file in dist/*/*.eap; do
        [ -f "$eap_file" ] || continue
        filename=$(basename "$eap_file")
        url="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/netbird-acap/${VERSION}/${filename}"
        
        ASSETS=$(echo "$ASSETS" | jq --arg name "$filename" --arg url "$url" \
          '. += [{"name": $name, "url": $url, "link_type": "package"}]')
      done
    - |
      curl --request POST \
           --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --header "Content-Type: application/json" \
           --data "$(jq -n \
             --arg name "v${VERSION}" \
             --arg tag "v${VERSION}" \
             --arg ref "${CI_COMMIT_SHA}" \
             --arg desc "${DESCRIPTION}" \
             --argjson assets "${ASSETS}" \
             '{name: $name, tag_name: $tag, ref: $ref, description: $desc, assets: {links: $assets}}')" \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
    - echo "Release v${VERSION} created successfully"

