
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

stages:
  - prepare
  - build
  - release

get-version:
  stage: prepare
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq git
  script:
    - TAG=$(curl -fsSL https://api.github.com/repos/netbirdio/netbird/releases/latest | jq -r .tag_name)
    - VERSION=${TAG#v}
    - echo "VERSION=$VERSION" >> build.env
    - |
      if git rev-parse "v$VERSION" >/dev/null 2>&1; then
        echo "BUILD_NEEDED=false" >> build.env
        echo "Version v$VERSION already exists, skipping"
      else
        echo "BUILD_NEEDED=true" >> build.env
        echo "New version detected: v$VERSION"
      fi
  artifacts:
    reports:
      dotenv: build.env

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache bash curl
  script:
    - |
      if [ "$BUILD_NEEDED" != "true" ]; then
        echo "Build not needed, skipping"
        exit 0
      fi
    - chmod +x build.sh
    - export NETBIRD_VERSION=$VERSION
    - ./build.sh
    - |
      if [ $(find dist -name "*.eap" | wc -l) -eq 0 ]; then
        echo "Error: No .eap files generated"
        exit 1
      fi
    - echo "Built artifacts:"
    - find dist -name "*.eap" -exec ls -lh {} \;
  artifacts:
    paths:
      - dist/
    expire_in: 90 days

release:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      if [ "$BUILD_NEEDED" != "true" ]; then
        echo "Release not needed, skipping"
        exit 0
      fi
    
    # Upload artifacts
    - |
      for eap_file in dist/*/*.eap; do
        [ -f "$eap_file" ] || continue
        filename=$(basename "$eap_file")
        echo "Uploading $filename..."
        curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
             --upload-file "$eap_file" \
             "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/netbird-acap/${VERSION}/${filename}"
      done
    
    # Create release without tag requirement
    - |
      DESCRIPTION="NetBird ACAP v${VERSION} for Axis cameras

      **Architectures:** armv7hf, aarch64

      **Upstream:** https://github.com/netbirdio/netbird/releases/tag/v${VERSION}"
    
    - |
      ASSETS='[]'
      for eap_file in dist/*/*.eap; do
        [ -f "$eap_file" ] || continue
        filename=$(basename "$eap_file")
        url="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/netbird-acap/${VERSION}/${filename}"
        
        ASSETS=$(echo "$ASSETS" | jq --arg name "$filename" --arg url "$url" \
          '. += [{"name": $name, "url": $url, "link_type": "package"}]')
      done
    
    - |
      curl --request POST \
           --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --header "Content-Type: application/json" \
           --data "{
             \"name\": \"v${VERSION}\",
             \"tag_name\": \"v${VERSION}\",
             \"ref\": \"${CI_COMMIT_SHA}\",
             \"description\": $(echo "$DESCRIPTION" | jq -Rs .),
             \"assets\": {
               \"links\": $ASSETS
             }
           }" \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
    
    - echo "Release v${VERSION} created successfully"
